<?php
/**
 * @file
 * Code for the Message Libarary feature.
 */
include_once 'message_library.features.inc';

/**
 * Implementation of hook_form_alter()
 *
 * Change the default placeholders for the (-Any-) options on the exposed filter
 */
function message_library_form_alter(&$form, $form_state, $form_id) {
  if(!empty($form_state['view']) && $form_state['view']->name == 'message_library') {
    // overrides <All> on the dropdown
    if (!empty($form['audience']['#options'])) {
      $form['audience']['#options']['All'] = t('<All target Audience>');
    }
    if (!empty($form['group_risk']['#options'])) {
      $form['group_risk']['#options']['All'] = t('<All groups>');
    }
    if (!empty($form['issues']['#options'])) {
      $form['issues']['#options']['All'] = t('<All issues>');
    }
    if (!empty($form['threat_title']['#options'])) {
      $form['threat_title']['#options']['All'] = t('<All threats>');
    }

    $form['search_api_views_fulltext']['#attributes'] = array('class' => array('ctools-auto-submit-exclude'));
  }
}

/**
 * Implements hook_menu().
 *
 * Creates a 'Message Library' section on the administration page
 */
function message_library_menu() {
  $items['admin/config/message_library'] = array(
    'title' => 'Message Library',
    'description' => 'Settings for the Message Library.',
    'position' => 'right',
    'weight' => -10,
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('administer site configuration'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );
  return $items;
}

/**
 * Implements hook_views_pre_execute()
 */
function message_library_views_pre_execute(&$view) {
  return;
  // @todo: it's will be good when the Solr sever is not accessible, or the
  // message_library_index not available, it still can work gracefully.
  $solr_server = search_api_server_load('solr_server');
  if ((!empty($solr_server)) && ($solr_server instanceof SearchApiServer)) {
    $solr_service = new SearchApiSolrService($solr_server);

    if (!$solr_service->ping()) {
      //
    }
  }
}

